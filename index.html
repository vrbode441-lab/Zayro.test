// بيانات الأنميات والأسئلة - محدثة ومصححة مع معالجة الأخطاء
const animeData = {
    "ناروتو": {
        image: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
        questions: [
            {
                question: "ما هو اسم الذئب ذو الذيول الذي يعيش داخل ناروتو؟",
                options: ["كوراما", "شوكاكو", "ماتاتابي", "إيسو"],
                correct: 0
            },
            {
                question: "من هو المعلم الذي علم ناروتو تقنية الراسينغان؟",
                options: ["جيرايا", "كاكاشي", "إيروكا", "هيروزن"],
                correct: 0
            },
            {
                question: "ما هي القرية التي ينتمي إليها ناروتو؟",
                options: ["قرية الورق المخفية", "قرية الضباب", "قرية الرمل", "قرية السحاب"],
                correct: 0
            },
            {
                question: "من هو والد ناروتو؟",
                options: ["ميناتو ناميكازي", "هاشيراما سينجو", "توبيراما", "هيروزن ساروتوبي"],
                correct: 0
            },
            {
                question: "ما هي التقنية الشهيرة التي ابتكرها ناروتو؟",
                options: ["راسينغان", "راسينشوريكين", "كاجي تشيغيري نو جوتسو", "تشيدوري"],
                correct: 1
            }
        ]
    },
    "ون بيس": {
        image: "https://images.unsplash.com/photo-1545569341-9eb8b30979d9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
        questions: [
            {
                question: "ما هو هدف لوفي الرئيسي؟",
                options: ["أن يصبح ملك القراصنة", "أن يصبح أقوى سياف في العالم", "أن يجد الكنز الأسطوري", "أن يدور حول العالم"],
                correct: 0
            },
            {
                question: "ما هي فاكهة الشيطان التي أكلها لوفي؟",
                options: ["غومو غومو نو مي", "ميرا ميرا نو مي", "هيتو هيتو نو مي", "أوبا أوبا نو مي"],
                correct: 0
            },
            {
                question: "من هو أول عضو انضم إلى طاقم لوفي؟",
                options: ["رورونوا زورو", "نامي", "سانجي", "أوسوب"],
                correct: 0
            },
            {
                question: "ما هو لقب رورونوا زورو؟",
                options: ["صائاد القراصنة", "سياف الصاعقة", "صائد الجوائز", "فارس البحر"],
                correct: 0
            }
        ]
    },
    "هجوم العمالقة": {
        image: "https://images.unsplash.com/photo-1639322537228-f710d046312a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80",
        questions: [
            {
                question: "ما هو اسم العملاق الذي يمتلكه إيرين؟",
                options: ["عملاق الهجوم", "عملاق المدرعة", "عملاق المؤنث", "عملاق الضخم"],
                correct: 0
            },
            {
                question: "من هو أقوى جندي في فيلق الاستطلاع؟",
                options: ["ليفاي", "إيرين", "ميكاسا", "أرmin"],
                correct: 0
            },
            {
                question: "ما هو الغرض من الجدران الثلاثة؟",
                options: ["حماية البشرية من العمالقة", "سجن للعمالقة", "معبد قديم", "قاعدة عسكرية"],
                correct: 0
            }
        ]
    }
};

// متغيرات التطبيق مع معالجة الأخطاء
let currentAnime = '';
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];

// تهيئة التطبيق
function initApp() {
    try {
        createParticles();
        loadAnimeCards();
        setupEventListeners();
    } catch (error) {
        console.error('Error initializing app:', error);
        showError('حدث خطأ في تحميل التطبيق');
    }
}

// إنشاء جسيمات الخلفية
function createParticles() {
    try {
        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer) return;

        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + 'vw';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (15 + Math.random() * 10) + 's';
            particlesContainer.appendChild(particle);
        }
    } catch (error) {
        console.error('Error creating particles:', error);
    }
}

// تحميل بطاقات الأنمي
function loadAnimeCards() {
    try {
        const animeGrid = document.getElementById('animeGrid');
        if (!animeGrid) return;

        animeGrid.innerHTML = '';
        
        Object.keys(animeData).forEach(animeName => {
            const anime = animeData[animeName];
            const card = document.createElement('div');
            card.className = 'anime-card';
            card.innerHTML = `
                <div class="anime-img">
                    <img src="${anime.image}" alt="${animeName}" onerror="this.style.background='linear-gradient(145deg, #1a1a2e, #252545)'; this.innerHTML='${animeName}'">
                </div>
                <h3>${animeName}</h3>
                <div class="anime-info">
                    <span>${anime.questions.length} أسئلة</span>
                    <span>اختبار</span>
                </div>
            `;
            card.addEventListener('click', () => startQuiz(animeName));
            animeGrid.appendChild(card);
        });
    } catch (error) {
        console.error('Error loading anime cards:', error);
        showError('حدث خطأ في تحميل بطاقات الأنمي');
    }
}

// إعداد مستمعي الأحداث
function setupEventListeners() {
    try {
        const backButton = document.getElementById('backButton');
        const nextButton = document.getElementById('nextButton');
        const restartButton = document.getElementById('restartButton');

        if (backButton) backButton.addEventListener('click', goBackToHome);
        if (nextButton) nextButton.addEventListener('click', goToNextQuestion);
        if (restartButton) restartButton.addEventListener('click', goBackToHome);
    } catch (error) {
        console.error('Error setting up event listeners:', error);
    }
}

// بدء الاختبار
function startQuiz(animeName) {
    try {
        if (!animeData[animeName]) {
            showError('الأنمي المطلوب غير موجود');
            return;
        }

        currentAnime = animeName;
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];

        showLoading(true);
        
        setTimeout(() => {
            showLoading(false);
            showQuiz();
            loadQuestion();
        }, 1000);
    } catch (error) {
        console.error('Error starting quiz:', error);
        showError('حدث خطأ في بدء الاختبار');
    }
}

// إظهار/إخفاء شاشة التحميل
function showLoading(show) {
    try {
        const loading = document.getElementById('loading');
        const homePage = document.getElementById('homePage');
        
        if (loading) loading.style.display = show ? 'block' : 'none';
        if (homePage) homePage.style.display = show ? 'none' : 'block';
    } catch (error) {
        console.error('Error showing loading:', error);
    }
}

// إظهار واجهة الاختبار
function showQuiz() {
    try {
        const homePage = document.getElementById('homePage');
        const quizContainer = document.getElementById('quizContainer');
        const quizTitle = document.getElementById('quizTitle');
        const quizAnimeInfo = document.getElementById('quizAnimeInfo');

        if (homePage) homePage.style.display = 'none';
        if (quizContainer) quizContainer.style.display = 'block';
        if (quizTitle) quizTitle.textContent = `اختبار ${currentAnime}`;
        if (quizAnimeInfo) {
            quizAnimeInfo.innerHTML = `
                <span>${animeData[currentAnime].questions.length} أسئلة</span>
                <span>${currentAnime}</span>
            `;
        }
    } catch (error) {
        console.error('Error showing quiz:', error);
    }
}

// تحميل السؤال الحالي
function loadQuestion() {
    try {
        const questions = animeData[currentAnime].questions;
        if (currentQuestionIndex >= questions.length) {
            showResults();
            return;
        }

        const question = questions[currentQuestionIndex];
        const questionText = document.getElementById('questionText');
        const optionsGrid = document.getElementById('optionsGrid');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const nextButton = document.getElementById('nextButton');

        if (questionText) questionText.textContent = question.question;
        
        if (optionsGrid) {
            optionsGrid.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectOption(index));
                optionsGrid.appendChild(optionElement);
            });
        }

        if (progressBar) {
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            progressBar.style.width = progress + '%';
        }

        if (progressText) {
            progressText.textContent = `السؤال ${currentQuestionIndex + 1} من ${questions.length}`;
        }

        if (nextButton) nextButton.disabled = true;
    } catch (error) {
        console.error('Error loading question:', error);
        showError('حدث خطأ في تحميل السؤال');
    }
}

// اختيار الإجابة
function selectOption(optionIndex) {
    try {
        const options = document.querySelectorAll('.option');
        const nextButton = document.getElementById('nextButton');

        options.forEach(option => option.classList.remove('selected'));
        options[optionIndex].classList.add('selected');

        userAnswers[currentQuestionIndex] = optionIndex;
        
        if (nextButton) nextButton.disabled = false;
    } catch (error) {
        console.error('Error selecting option:', error);
    }
}

// الانتقال للسؤال التالي
function goToNextQuestion() {
    try {
        const questions = animeData[currentAnime].questions;
        const userAnswer = userAnswers[currentQuestionIndex];
        
        if (userAnswer === questions[currentQuestionIndex].correct) {
            score++;
        }

        currentQuestionIndex++;
        loadQuestion();
    } catch (error) {
        console.error('Error going to next question:', error);
        showError('حدث خطأ في الانتقال للسؤال التالي');
    }
}

// إظهار النتائج
function showResults() {
    try {
        const quizContainer = document.getElementById('quizContainer');
        const resultContainer = document.getElementById('resultContainer');
        const scoreText = document.getElementById('scoreText');
        const ratingText = document.getElementById('ratingText');
        const resultMessage = document.getElementById('resultMessage');

        const totalQuestions = animeData[currentAnime].questions.length;
        const percentage = (score / totalQuestions) * 100;

        if (quizContainer) quizContainer.style.display = 'none';
        if (resultContainer) resultContainer.style.display = 'block';
        if (scoreText) scoreText.textContent = `${score}/${totalQuestions}`;

        let rating = '';
        let message = '';

        if (percentage >= 90) {
            rating = 'خبير أنمي!';
            message = 'مذهل! معرفتك رائعة بهذا الأنمي';
        } else if (percentage >= 70) {
            rating = 'محترف';
            message = 'أداء ممتاز! لديك معرفة قوية';
        } else if (percentage >= 50) {
            rating = 'متوسط';
            message = 'جيد، ولكن يمكنك تحسين معرفتك';
        } else {
            rating = 'مبتدئ';
            message = 'حاول مشاهدة الأنمي مرة أخرى لتحسين نتيجتك';
        }

        if (ratingText) ratingText.textContent = rating;
        if (resultMessage) resultMessage.textContent = message;
    } catch (error) {
        console.error('Error showing results:', error);
        showError('حدث خطأ في عرض النتائج');
    }
}

// العودة للصفحة الرئيسية
function goBackToHome() {
    try {
        const homePage = document.getElementById('homePage');
        const quizContainer = document.getElementById('quizContainer');
        const resultContainer = document.getElementById('resultContainer');

        if (homePage) homePage.style.display = 'block';
        if (quizContainer) quizContainer.style.display = 'none';
        if (resultContainer) resultContainer.style.display = 'none';
    } catch (error) {
        console.error('Error going back to home:', error);
    }
}

// إظهار رسالة خطأ
function showError(message) {
    try {
        alert(message);
    } catch (error) {
        console.error('Error showing error message:', error);
    }
}

// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', initApp);
